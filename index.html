<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Arena Retro</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    .container {
      width: 80%;
      margin: 2rem auto;
      background: #111;
      padding: 2rem;
      border: 2px solid #c77fdf;
      box-shadow: 0 0 10px #c77fdf;
      font-family: 'Press Start 2P', monospace;
      color: #c77fdf;
    }

    .header { text-align: center; margin-bottom: 2rem; }

    .header h1 {
      font-size: 2.5rem;
      color: #c77fdf;
      text-shadow: 0 0 5px #c77fdf;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      border-bottom: 2px dashed #c77fdf;
    }

    .navbar li {
      padding: 1rem 2rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    .navbar li:hover { background: #222; }
    .navbar li.active { background: #333; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    form label { font-weight: bold; font-size: 1rem; }

    #prompt { rows: 8; width: 100%; }
    #assistantReply { rows: 16; width: 100%; }

    form input[type="text"],
    form textarea {
      background: #222;
      color: #c77fdf;
      border: 1px solid #c77fdf;
      padding: 0.5rem;
      font-family: inherit;
    }

    #assistantReply:disabled {
      background: #222 !important;
      color: #c77fdf !important;
      border: 1px solid #c77fdf !important;
      opacity: 1;
    }

    form button {
      background: #c77fdf;
      color: #111;
      border: none;
      padding: 0.75rem;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      text-transform: uppercase;
      transition: background 0.3s, color 0.3s;
    }

    form button:hover { background: #fff; color: #000; }
    form button:disabled { opacity: 0.5; cursor: not-allowed; }

    .leaderboard-table {
      width: 80%;
      margin: 1rem auto;
      border-collapse: collapse;
      color: #fff;
      text-align: center;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      border: 1px solid #c77fdf;
      padding: 0.5rem;
    }

    .spinner {
      display: inline-block;
      margin-left: 8px;
      width: 14px;
      height: 14px;
      border: 2px solid #111;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .char-counter {
      text-align: right;
      font-size: 0.8rem;
      color: #888;
      margin-top: -0.5rem;
    }

    .char-counter.warning { color: #ff9800; }
    .char-counter.error { color: #f44336; }

    .error-message {
      color: #f44336;
      font-size: 0.9rem;
      margin-top: -0.5rem;
    }

    body { background: black !important; }
    p { font-family: Poppins !important; }

    @media (max-width: 768px) {
      #assistantReply:disabled, #prompt { line-height: 1.5; }
      .navbar { flex-direction: column; align-items: flex-start; display: flex; }
      .navbar ul { display: block !important; width: 100%; text-align: center !important; }
    }

    @media (max-width: 768px) {
      .leaderboard-table, .leaderboard-table thead, .leaderboard-table tbody,
      .leaderboard-table tr, .leaderboard-table th, .leaderboard-table td {
        display: block;
        width: 100%;
      }
      .leaderboard-table tr { margin-bottom: 1rem; }
      .leaderboard-table th {
        display: block;
        text-align: left;
        padding: 8px 0;
        font-weight: bold;
        color: #fff;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .leaderboard-table td {
        text-align: left;
        padding: 8px 0;
        position: relative;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .leaderboard-table td::before {
        content: attr(data-label);
        font-weight: bold;
        text-transform: uppercase;
        display: none;
      }
    }
  
    /* ====== Responsive improvements ====== */
    body { -webkit-text-size-adjust: 100%; }

    @media (max-width: 1024px) {
      .container { width: 92%; }
      .header h1 { font-size: 2rem; }
    }

    @media (max-width: 768px) {
      .container { width: 96%; margin: 1rem auto; padding: 1rem; }
      .header h1 { font-size: 1.6rem; }
      h2 { font-size: 1.1rem; }
      form { gap: 0.75rem; }
      form label { font-size: 0.75rem; line-height: 1.3; }
      form input[type="text"], form textarea { font-size: 0.75rem; padding: 0.6rem; }
      #assistantReply { min-height: 260px; }
      .navbar li { padding: 0.75rem 1rem; font-size: 0.75rem; }
      .char-counter, #rateLimitInfo { font-size: 0.7rem; }
      form button { font-size: 0.85rem; padding: 0.9rem; }
    }

    /* Leaderboard table: keep desktop table, switch to card rows on small screens */
    @media (max-width: 768px) {
      .leaderboard-table { width: 100%; }
      .leaderboard-table thead { display: none; }
      .leaderboard-table, .leaderboard-table tbody, .leaderboard-table tr, .leaderboard-table td {
        display: block;
        width: 100%;
      }
      .leaderboard-table tr {
        margin: 0 0 0.75rem 0;
        border: 1px solid #c77fdf;
        padding: 0.5rem 0.75rem;
        background: #141414;
      }
      .leaderboard-table td {
        border: none;
        padding: 0.35rem 0;
        text-align: left;
      }
      .leaderboard-table td::before {
        content: attr(data-label) ": ";
        font-weight: bold;
        display: inline;
      }
    }

  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>PROMPT ARENA</h1>
    </header>

    <nav class="navbar">
      <ul>
        <li class="active" data-tab="tab-inicio">Inicio</li>
        <li data-tab="tab-leaderboard">Leaderboard</li>
      </ul>
    </nav>

    <section id="tab-inicio" class="tab-content active">
      <h2>Bienvenido</h2>
      <form id="promptForm">
        <label for="username">Nombre de Usuario (máx. 50 caracteres)</label>
        <input type="text" id="username" name="username" maxlength="50" required>
        <div id="usernameError" class="error-message" style="display: none;"></div>

        <label for="prompt">Prompt (10-2500 caracteres)</label>
        <textarea id="prompt" name="prompt" rows="8" required></textarea>
        <div class="char-counter" id="charCounter">0 / 2500</div>
        <div id="promptError" class="error-message" style="display: none;"></div>

        <label for="assistantReply">Respuesta</label>
        <textarea id="assistantReply" name="assistantReply" rows="16" disabled>Aquí aparecerá la valoración de tu prompt</textarea>

        <button type="submit" id="startButton">Empezar</button>
        <div id="rateLimitInfo" style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; color: #888;"></div>
      </form>
    </section>

    <section id="tab-leaderboard" class="tab-content">
      <h2>Leaderboard</h2>
      <p>Aquí puedes ver tu puntuación si estás en el TOP100!</p>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Posición</th>
            <th>Nombre</th>
            <th>Puntuación</th>
          </tr>
        </thead>
        <tbody id="leaderboardTableBody"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ========================================
    // CONFIGURACIÓN
    // ========================================
    const CONFIG = {
      makeWebhookUrl: "https://automatizaciones-n8n.emtgxo.easypanel.host/webhook/make-in",
      // Mantengo tu CSV actual (2 columnas: Nombre,Puntuación)
      publishedCsvUrl: "https://docs.google.com/spreadsheets/d/1J4EFIh4kzGIf3jjnW8U7ouXtYCFVeOFRxGUugmQS-KU/export?format=csv&gid=0",

      // IMPORTANTE: tu n8n hoy valida token -> lo volvemos a mandar
      secretToken: "a7f3e9d2c8b6f1a4e7d9c2b8f5a1e6d3c9b7f2a5e8d1c6b9f3a7e2d5c8b1f4a6e9d3c7b2f5a8e1d4c9b6f2a7e3d8c5b1f9a4e7d2c6b8f3a5e9d1c7b4f2a6e8d3c9",

      maxPromptLength: 2500,
      minPromptLength: 10,
      maxUsernameLength: 50,
      rateLimitWindow: 300000, // 5 minutos
      maxAttemptsPerWindow: 3,
      requestTimeout: 60000 // 60 segundos
    };

    // ========================================
    // USER ID ÚNICO Y PERSISTENTE
    // ========================================
    function getOrCreateUserId() {
      const key = "promptArenaUserId";
      let id = localStorage.getItem(key);
      if (!id) {
        // UUID v4 usando crypto (sin librerías)
        id = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
          const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
        localStorage.setItem(key, id);
      }
      return id;
    }
    const USER_ID = getOrCreateUserId();

    // ========================================
    // ELEMENTOS DEL DOM
    // ========================================
    const tabButtons = document.querySelectorAll('.navbar li');
    const tabContents = document.querySelectorAll('.tab-content');
    const promptForm = document.getElementById('promptForm');
    const usernameInput = document.getElementById('username');
    const promptInput = document.getElementById('prompt');
    const assistantReply = document.getElementById('assistantReply');
    const startButton = document.getElementById('startButton');
    const charCounter = document.getElementById('charCounter');
    const usernameError = document.getElementById('usernameError');
    const promptError = document.getElementById('promptError');
    const rateLimitInfo = document.getElementById('rateLimitInfo');

    // ========================================
    // RATE LIMITER (POR userId, NO POR username)
    // ========================================
    const rateLimiter = {
      attempts: JSON.parse(localStorage.getItem('rateLimiterAttempts') || '{}'),

      saveToStorage() {
        localStorage.setItem('rateLimiterAttempts', JSON.stringify(this.attempts));
      },

      check(userId) {
        const now = Date.now();
        const key = String(userId);

        if (!this.attempts[key]) this.attempts[key] = [];

        // limpiar intentos antiguos
        this.attempts[key] = this.attempts[key].filter(
          time => now - time < CONFIG.rateLimitWindow
        );

        // verificar límite
        if (this.attempts[key].length >= CONFIG.maxAttemptsPerWindow) {
          const oldestAttempt = Math.min(...this.attempts[key]);
          const timeUntilReset = CONFIG.rateLimitWindow - (now - oldestAttempt);
          const minutesLeft = Math.ceil(timeUntilReset / 60000);
          return { allowed: false, minutesLeft };
        }

        // registrar intento
        this.attempts[key].push(now);
        this.saveToStorage();

        const remainingAttempts = CONFIG.maxAttemptsPerWindow - this.attempts[key].length;
        return { allowed: true, remainingAttempts };
      },

      getRemainingAttempts(userId) {
        const key = String(userId);
        const now = Date.now();

        if (!this.attempts[key]) return CONFIG.maxAttemptsPerWindow;

        this.attempts[key] = this.attempts[key].filter(
          time => now - time < CONFIG.rateLimitWindow
        );

        return Math.max(0, CONFIG.maxAttemptsPerWindow - this.attempts[key].length);
      }
    };

    // ========================================
    // SANITIZACIÓN
    // ========================================
    function sanitizeInput(input) {
      let sanitized = input.replace(/<[^>]*>/g, '');
      sanitized = sanitized.replace(/[\x00-\x1F\x7F]/g, '');
      return sanitized.trim();
    }

    // ========================================
    // VALIDACIÓN
    // ========================================
    function validateUsername(username) {
      if (!username || username.length === 0) {
        return { valid: false, error: "El nombre de usuario es obligatorio" };
      }
      if (username.length > CONFIG.maxUsernameLength) {
        return { valid: false, error: `El nombre es demasiado largo (máx ${CONFIG.maxUsernameLength} caracteres)` };
      }
      if (!/^[a-zA-Z0-9_\-\sáéíóúñÁÉÍÓÚÑ]+$/.test(username)) {
        return { valid: false, error: "El nombre solo puede contener letras, números, guiones y espacios" };
      }
      return { valid: true };
    }

    function validatePrompt(prompt) {
      if (!prompt || prompt.length === 0) {
        return { valid: false, error: "El prompt es obligatorio" };
      }
      if (prompt.length < CONFIG.minPromptLength) {
        return { valid: false, error: `El prompt debe tener al menos ${CONFIG.minPromptLength} caracteres` };
      }
      if (prompt.length > CONFIG.maxPromptLength) {
        return { valid: false, error: `El prompt es demasiado largo (máx ${CONFIG.maxPromptLength} caracteres)` };
      }
      return { valid: true };
    }

    // ========================================
    // CONTADOR DE CARACTERES
    // ========================================
    promptInput.addEventListener('input', () => {
      const length = promptInput.value.length;
      charCounter.textContent = `${length} / ${CONFIG.maxPromptLength}`;

      if (length > CONFIG.maxPromptLength) {
        charCounter.classList.add('error');
        charCounter.classList.remove('warning');
      } else if (length > CONFIG.maxPromptLength * 0.9) {
        charCounter.classList.add('warning');
        charCounter.classList.remove('error');
      } else {
        charCounter.classList.remove('warning', 'error');
      }
    });

    // ========================================
    // MOSTRAR INTENTOS RESTANTES (por userId)
    // ========================================
    usernameInput.addEventListener('blur', () => {
      const remaining = rateLimiter.getRemainingAttempts(USER_ID);
      rateLimitInfo.textContent = `Intentos restantes: ${remaining} / ${CONFIG.maxAttemptsPerWindow}`;
      rateLimitInfo.style.color = remaining === 0 ? '#f44336' : '#888';
    });

    // ========================================
    // MANEJO DE PESTAÑAS
    // ========================================
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        const tabTarget = button.getAttribute('data-tab');
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === tabTarget) content.classList.add('active');
        });

        if (tabTarget === 'tab-leaderboard') {
          loadLeaderboardData();
        }
      });
    });

    // ========================================
    // SUBMIT DEL FORMULARIO
    // ========================================
    promptForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      usernameError.style.display = 'none';
      promptError.style.display = 'none';
      assistantReply.value = '';

      const username = sanitizeInput(usernameInput.value);
      const prompt = sanitizeInput(promptInput.value);

      const usernameValidation = validateUsername(username);
      if (!usernameValidation.valid) {
        usernameError.textContent = usernameValidation.error;
        usernameError.style.display = 'block';
        return;
      }

      const promptValidation = validatePrompt(prompt);
      if (!promptValidation.valid) {
        promptError.textContent = promptValidation.error;
        promptError.style.display = 'block';
        return;
      }

      // Rate limit por userId
      const rateLimitCheck = rateLimiter.check(USER_ID);
      if (!rateLimitCheck.allowed) {
        assistantReply.value = `Has alcanzado el límite de intentos.\n\nEspera ${rateLimitCheck.minutesLeft} minuto(s) antes de intentar de nuevo.`;
        return;
      }

      rateLimitInfo.textContent = `Intentos restantes: ${rateLimitCheck.remainingAttempts} / ${CONFIG.maxAttemptsPerWindow}`;
      rateLimitInfo.style.color = rateLimitCheck.remainingAttempts === 0 ? '#f44336' : '#888';

      startButton.disabled = true;
      startButton.innerHTML = "Analizando... <span class='spinner'></span>";
      assistantReply.value = "Procesando tu prompt...\n\nEsto puede tardar hasta 30 segundos.";

      // Payload compatible con tu n8n actual (incluye token)
      const payload = {
        userId: USER_ID,            // NUEVO: clave única (usa esto en n8n para no pisar por nombre)
        username: username,         // display
        prompt: prompt,             // prompt a evaluar
        token: CONFIG.secretToken,  // compatibilidad con tu validación actual
        timestamp: Date.now()
      };

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), CONFIG.requestTimeout);

        const response = await fetch(CONFIG.makeWebhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.status}`);
        }

        const responseText = await response.text();
        if (!responseText || responseText.trim() === '') {
          throw new Error('El servidor no devolvió ninguna respuesta');
        }

        assistantReply.value = responseText;
        assistantReply.scrollIntoView({ behavior: 'smooth', block: 'center' });

      } catch (error) {
        if (error.name === 'AbortError') {
          assistantReply.value = "Timeout: El servidor tardó demasiado en responder.\n\nIntenta de nuevo en unos momentos.";
        } else if (String(error.message).includes('Failed to fetch')) {
          assistantReply.value = "Error de conexión.\n\nVerifica tu conexión a internet e intenta de nuevo.";
        } else {
          assistantReply.value = `Error: ${error.message}\n\nSi el problema persiste, contacta al administrador.`;
        }
        console.error('Error completo:', error);
      } finally {
        startButton.disabled = false;
        startButton.textContent = "Empezar";
      }
    });

    
    // ========================================
    // CARGAR LEADERBOARD (CSV: userId,Nombre,Puntuación)
    // ========================================
    function parseCsvLine(line) {
      // Simple CSV parser with quotes support
      const out = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          // Escaped quote
          if (inQuotes && line[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (ch === ',' && !inQuotes) {
          out.push(cur);
          cur = '';
          continue;
        }

        cur += ch;
      }
      out.push(cur);
      return out.map(v => v.trim());
    }

    function loadLeaderboardData() {
      const leaderboardBody = document.getElementById('leaderboardTableBody');
      leaderboardBody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';

      fetch(CONFIG.publishedCsvUrl, { cache: "no-store" })
        .then(response => {
          if (!response.ok) throw new Error("No se pudo obtener la hoja en CSV");
          return response.text();
        })
        .then(csvText => {
          const rawLines = csvText.replace(/\r/g, '').trim().split("\n").filter(Boolean);
          if (rawLines.length <= 1) {
            leaderboardBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles</td></tr>';
            return;
          }

          // Header -> indices
          const header = parseCsvLine(rawLines[0]).map(h => h.replace(/^"|"$/g, '').trim().toLowerCase());
          const idxUserId = header.indexOf('userid');
          const idxNombre = header.indexOf('nombre');
          const idxPuntos = header.indexOf('puntuación') !== -1 ? header.indexOf('puntuación') : header.indexOf('puntuacion');

          // Backwards compatibility (old sheet: Nombre,Puntuación)
          const fallbackNombre = idxNombre === -1 ? 0 : idxNombre;
          const fallbackPuntos = idxPuntos === -1 ? 1 : idxPuntos;

          const records = [];

          for (let i = 1; i < rawLines.length; i++) {
            const cols = parseCsvLine(rawLines[i]);
            if (cols.length < 2) continue;

            const nombre = sanitizeInput((cols[fallbackNombre] || '').replace(/^"|"$/g, ''));
            const puntosStr = (cols[fallbackPuntos] || '').replace(/^"|"$/g, '').trim();
            const puntos = parseFloat(puntosStr) || 0;

            if (nombre && puntos > 0) {
              records.push({
                nombre,
                puntuacion: puntos
              });
            }
          }

          records.sort((a, b) => b.puntuacion - a.puntuacion);
          const topRecords = records.slice(0, 100);

          leaderboardBody.innerHTML = '';

          if (topRecords.length === 0) {
            leaderboardBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles</td></tr>';
            return;
          }

          topRecords.forEach((item, index) => {
            const row = document.createElement('tr');

            const posCell = document.createElement('td');
            posCell.textContent = index + 1;
            posCell.setAttribute('data-label', 'Posición');
            row.appendChild(posCell);

            const nameCell = document.createElement('td');
            nameCell.textContent = item.nombre;
            nameCell.setAttribute('data-label', 'Nombre');
            row.appendChild(nameCell);

            const pointsCell = document.createElement('td');
            pointsCell.textContent = String(item.puntuacion);
            pointsCell.setAttribute('data-label', 'Puntuación');
            row.appendChild(pointsCell);

            leaderboardBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error cargando leaderboard:', error);
          leaderboardBody.innerHTML = '<tr><td colspan="3">Error al cargar el leaderboard</td></tr>';
        });
    }

  </script>
</body>
</html>
