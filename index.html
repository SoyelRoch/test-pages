<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Arena</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: black !important; }
    
    .container {
      width: 80%; margin: 2rem auto; background: #111; padding: 2rem;
      border: 2px solid #c77fdf; box-shadow: 0 0 10px #c77fdf;
      font-family: 'Press Start 2P', monospace; color: #c77fdf;
    }
    
    .header { text-align: center; margin-bottom: 2rem; }
    .header h1 { font-size: 2.5rem; color: #c77fdf; text-shadow: 0 0 5px #c77fdf; }
    
    .navbar ul {
      list-style: none; display: flex; justify-content: center;
      margin-bottom: 2rem; border-bottom: 2px dashed #c77fdf;
    }
    .navbar li {
      padding: 1rem 2rem; cursor: pointer; transition: background 0.3s;
    }
    .navbar li:hover { background: #222; }
    .navbar li.active { background: #333; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    form {
      display: flex; flex-direction: column; gap: 1rem;
      width: 100%; max-width: 800px; margin: 0 auto;
    }
    form label { font-weight: bold; font-size: 1rem; }
    #prompt { rows: 8; width: 100%; }
    #assistantReply { rows: 16; width: 100%; }
    
    form input[type="text"], form textarea {
      background: #222; color: #c77fdf; border: 1px solid #c77fdf;
      padding: 0.5rem; font-family: inherit; font-size: 0.9rem;
      line-height: 1.5;
    }
    
    #assistantReply:disabled {
      background: #222 !important; color: #c77fdf !important;
      border: 1px solid #c77fdf !important; opacity: 1;
    }
    
    form button {
      background: #c77fdf; color: #111; border: none;
      padding: 0.75rem; cursor: pointer; font-family: inherit;
      font-size: 1rem; text-transform: uppercase;
      transition: background 0.3s, color 0.3s;
    }
    form button:hover { background: #fff; color: #000; }
    form button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .leaderboard-table {
      width: 80%; margin: 1rem auto; border-collapse: collapse;
      color: #fff; text-align: center;
    }
    .leaderboard-table th, .leaderboard-table td {
      border: 1px solid #c77fdf; padding: 0.5rem;
    }
    
    .spinner {
      display: inline-block; margin-left: 8px;
      width: 14px; height: 14px; border: 2px solid #111;
      border-top-color: transparent; border-radius: 50%;
      animation: spin 0.8s linear infinite; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    p { font-family: Poppins, Arial, sans-serif !important; }
    
    @media (max-width: 768px) {
      #assistantReply:disabled, #prompt { line-height: 1.5; }
      .navbar { flex-direction: column; align-items: flex-start; display: flex; }
      .navbar ul { display: block !important; width: 100%; text-align: center !important; }
      .leaderboard-table, .leaderboard-table thead, .leaderboard-table tbody,
      .leaderboard-table tr, .leaderboard-table th, .leaderboard-table td {
        display: block; width: 100%;
      }
      .leaderboard-table tr { margin-bottom: 1rem; }
      .leaderboard-table th, .leaderboard-table td {
        text-align: left; padding: 8px 0; border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>PROMPT ARENA</h1>
    </header>

    <nav class="navbar">
      <ul>
        <li class="active" data-tab="tab-inicio">Inicio</li>
        <li data-tab="tab-leaderboard">Leaderboard</li>
      </ul>
    </nav>

    <section id="tab-inicio" class="tab-content active">
      <h2>Bienvenido</h2>
      <form id="promptForm">
        <label for="username">Nombre de Usuario</label>
        <input type="text" id="username" name="username" required>

        <label for="prompt">Prompt</label>
        <textarea id="prompt" name="prompt" rows="8" required></textarea>

        <label for="assistantReply">Respuesta</label>
        <textarea id="assistantReply" name="assistantReply" rows="16" disabled>Aqu√≠ aparecer√° la valoraci√≥n de tu prompt</textarea>

        <button type="submit" id="startButton">Empezar</button>
      </form>
    </section>

    <section id="tab-leaderboard" class="tab-content">
      <h2>Leaderboard</h2>
      <p>Aqu√≠ puedes ver tu puntuaci√≥n si est√°s en el TOP100!</p>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Posici√≥n</th>
            <th>Nombre</th>
            <th>Puntuaci√≥n</th>
          </tr>
        </thead>
        <tbody id="leaderboardTableBody">
        </tbody>
      </table>
    </section>
  </div>

  <script>
    // ========================================
    // CONFIGURACI√ìN
    // ========================================
    
    const N8N_WEBHOOK = "https://automatizaciones-n8n.emtgxo.easypanel.host/webhook/1aa1195d-8a21-4bc2-8458-84831f03b376";
    
    // URL del CSV p√∫blico de Google Sheets
    // Formato: https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/export?format=csv&gid=0
    const GOOGLE_SHEETS_CSV = "https://docs.google.com/spreadsheets/d/TU_SPREADSHEET_ID/export?format=csv&gid=0";

    // ========================================
    // NAVEGACI√ìN ENTRE TABS
    // ========================================
    
    const tabButtons = document.querySelectorAll('.navbar li');
    const tabContents = document.querySelectorAll('.tab-content');
    const promptForm = document.getElementById('promptForm');
    const assistantReply = document.getElementById('assistantReply');
    const startButton = document.getElementById('startButton');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const tabTarget = button.getAttribute('data-tab');
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === tabTarget) content.classList.add('active');
        });
        if (tabTarget === 'tab-leaderboard') loadLeaderboardData();
      });
    });

    // ========================================
    // ENV√çO DE PROMPT AL WEBHOOK DE N8N
    // ========================================
    
    promptForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const prompt = document.getElementById('prompt').value.trim();

      if (!username || !prompt) {
        assistantReply.value = "Debes rellenar todos los campos.";
        return;
      }

      startButton.disabled = true;
      startButton.innerHTML = "Procesando... <span class='spinner'></span>";
      assistantReply.value = "‚è≥ Enviando tu prompt a N8N para evaluaci√≥n...";

      try {
        console.log('üì§ Enviando prompt al webhook de N8N...');
        const response = await fetch(N8N_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, username })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error del servidor');
        }

        console.log('‚úÖ Respuesta recibida de N8N:', data);
        
        // Mostrar la respuesta del evaluador
        let message = data.response || data.message || 'Respuesta procesada';
        
        // Si hay informaci√≥n de actualizaci√≥n de BD
        if (data.dbUpdate) {
          if (data.dbUpdate.updated) {
            message += `\n\n‚úÖ ${data.dbUpdate.message}`;
          } else {
            message += `\n\n‚ÑπÔ∏è ${data.dbUpdate.message}`;
          }
        }
        
        // Si hay score
        if (data.score !== undefined && data.score !== null) {
          message += `\n\nüìä Puntuaci√≥n: ${data.score}/100`;
        }
        
        assistantReply.value = message;

      } catch (error) {
        console.error('‚ùå Error:', error);
        assistantReply.value = "‚ùå Error: " + error.message;
      } finally {
        startButton.disabled = false;
        startButton.textContent = "Empezar";
      }
    });

    // ========================================
    // CARGAR LEADERBOARD DESDE GOOGLE SHEETS CSV
    // ========================================
    
    async function loadLeaderboardData() {
      const leaderboardBody = document.getElementById('leaderboardTableBody');
      leaderboardBody.innerHTML = "<tr><td colspan='3'>Cargando...</td></tr>";

      try {
        console.log('üìä Cargando leaderboard desde Google Sheets...');
        
        const response = await fetch(GOOGLE_SHEETS_CSV);
        
        if (!response.ok) {
          throw new Error('Error cargando el CSV');
        }
        
        const csvText = await response.text();
        
        // Parsear CSV manualmente (simple)
        const lines = csvText.split('\n');
        const data = [];
        
        // Saltar la primera l√≠nea (headers)
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Dividir por comas (asumiendo formato: username,score)
          const parts = line.split(',');
          if (parts.length >= 2) {
            const username = parts[0].trim();
            const score = parseInt(parts[1].trim(), 10);
            
            if (username && !isNaN(score)) {
              data.push({ username, score });
            }
          }
        }
        
        // Ordenar por score descendente
        data.sort((a, b) => b.score - a.score);
        
        // Limitar a top 100
        const top100 = data.slice(0, 100);
        
        leaderboardBody.innerHTML = "";

        if (top100.length === 0) {
          leaderboardBody.innerHTML = "<tr><td colspan='3'>No hay datos disponibles</td></tr>";
          return;
        }

        top100.forEach((item, index) => {
          const row = document.createElement('tr');
          
          const posCell = document.createElement('td');
          posCell.textContent = index + 1;
          row.appendChild(posCell);
          
          const nameCell = document.createElement('td');
          nameCell.textContent = item.username;
          row.appendChild(nameCell);
          
          const scoreCell = document.createElement('td');
          scoreCell.textContent = item.score;
          row.appendChild(scoreCell);
          
          leaderboardBody.appendChild(row);
        });

        console.log(`‚úÖ Leaderboard cargado: ${top100.length} usuarios`);

      } catch (error) {
        console.error('‚ùå Error cargando leaderboard:', error);
        leaderboardBody.innerHTML = "<tr><td colspan='3'>Error al cargar el leaderboard</td></tr>";
      }
    }

    console.log('üöÄ Prompt Arena inicializado con N8N');
    console.log('üì° Webhook:', N8N_WEBHOOK);
  </script>
</body>
</html>
